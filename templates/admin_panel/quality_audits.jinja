{% extends "base.jinja" %}

{% block title %}Quality Audits - RankTutor{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-8 py-6 sm:py-8">
    <div class="mb-6">
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-2">Quality Assurance</h1>
        <p class="text-sm sm:text-base text-gray-600">Monitor and improve tutor quality across the platform</p>
    </div>
    
    <!-- Info Box: What is "Needs Intervention"? -->
    <div class="bg-blue-50 border-l-4 border-blue-400 rounded-lg p-4 sm:p-6 mb-6">
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 sm:h-6 sm:w-6 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                </svg>
            </div>
            <div class="ml-3 flex-1">
                <h3 class="text-sm sm:text-base font-semibold text-blue-900 mb-2">What is "⚠ Needs Intervention"?</h3>
                <p class="text-xs sm:text-sm text-blue-800 mb-2">
                    Tutors marked with "⚠ Needs Intervention" have a quality score below 50/100 or have unresolved quality issues. These tutors require immediate review and action.
                </p>
                <div class="text-xs sm:text-sm text-blue-700">
                    <p class="font-semibold mb-1">Quality Score Breakdown:</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong>80-100:</strong> Excellent (Green) - No action needed</li>
                        <li><strong>50-79:</strong> Good (Yellow) - Monitor regularly</li>
                        <li><strong>Below 50:</strong> Needs Intervention (Red) - Requires review</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tutors Needing Intervention -->
    {% if tutors_needing_intervention %}
    <div class="bg-red-50 border-2 border-red-300 rounded-lg p-4 sm:p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg sm:text-xl font-semibold text-red-800 flex items-center gap-2">
                <span>⚠️</span>
                <span>Tutors Requiring Intervention ({{ tutors_needing_intervention|length }})</span>
            </h2>
        </div>
        <div class="space-y-3">
            {% for tutor in tutors_needing_intervention %}
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center bg-white p-4 rounded-lg border border-red-200 gap-3">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                        <p class="font-semibold text-gray-900">{{ tutor.user.get_full_name()|default(tutor.user.username) }}</p>
                        <span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-red-100 text-red-800">⚠ Needs Intervention</span>
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs sm:text-sm text-gray-600">
                        <p><strong>Quality Score:</strong> <span class="font-semibold text-red-600">{{ tutor.quality_score|floatformat(1) }}/100</span></p>
                        <p><strong>Rating:</strong> {{ tutor.average_rating|default('0.0')|floatformat(1) }}/5.0</p>
                        <p><strong>Reviews:</strong> {{ tutor.total_reviews }}</p>
                        <p><strong>Verified:</strong> {{ 'Yes' if tutor.is_verified else 'No' }}</p>
                    </div>
                    {% if tutor.quality_issues %}
                    <p class="text-xs text-gray-600 mt-2"><strong>Issues:</strong> {{ tutor.quality_issues|truncatewords(15) }}</p>
                    {% endif %}
                </div>
                <div class="flex gap-2">
                    <a href="{{ url('admin_panel:conduct_audit', tutor.id) }}" class="flex-1 sm:flex-none bg-red-600 text-white px-4 py-2.5 rounded-md hover:bg-red-700 text-sm font-medium text-center min-h-[44px] flex items-center justify-center">
                        Conduct Audit
                    </a>
                    <a href="{{ url('admin_panel:tutor_detail', tutor.id) }}" class="flex-1 sm:flex-none bg-gray-200 text-gray-700 px-4 py-2.5 rounded-md hover:bg-gray-300 text-sm font-medium text-center min-h-[44px] flex items-center justify-center">
                        View Profile
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="bg-green-50 border border-green-200 rounded-lg p-4 sm:p-6 mb-6">
        <div class="flex items-center gap-2">
            <svg class="h-5 w-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
            </svg>
            <p class="text-sm sm:text-base font-medium text-green-800">✅ No tutors currently require intervention. All tutors meet quality standards.</p>
        </div>
    </div>
    {% endif %}
    
    <!-- Low Quality Tutors (but not yet flagged for intervention) -->
    {% if low_quality_tutors %}
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 sm:p-6 mb-6">
        <h2 class="text-lg sm:text-xl font-semibold mb-4 text-yellow-800">⚠️ Low Quality Tutors (Score < 50)</h2>
        <p class="text-xs sm:text-sm text-yellow-700 mb-4">These tutors have low scores but may not be flagged for intervention yet. Review and audit them proactively.</p>
        <div class="space-y-3">
            {% for tutor in low_quality_tutors %}
            {% if not tutor.intervention_required %}
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center bg-white p-4 rounded-lg border border-yellow-200 gap-3">
                <div class="flex-1">
                    <p class="font-semibold text-gray-900">{{ tutor.user.get_full_name()|default(tutor.user.username) }}</p>
                    <p class="text-sm text-gray-600">Quality Score: <span class="font-semibold text-yellow-600">{{ tutor.quality_score|floatformat(1) }}/100</span></p>
                </div>
                <a href="{{ url('admin_panel:conduct_audit', tutor.id) }}" class="bg-yellow-600 text-white px-4 py-2.5 rounded-md hover:bg-yellow-700 text-sm font-medium text-center min-h-[44px] flex items-center justify-center">
                    Conduct Audit
                </a>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Recent Audits -->
    <div class="bg-white rounded-lg shadow">
        <div class="p-4 sm:p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <h2 class="text-lg sm:text-xl font-semibold">Recent Quality Audits</h2>
                <span class="text-xs sm:text-sm text-gray-500">Last 50 audits</span>
            </div>
        </div>
        {% if audits %}
            <div class="divide-y divide-gray-200">
                {% for audit in audits %}
                <div class="p-4 sm:p-6 hover:bg-gray-50 transition-colors">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <p class="font-semibold text-gray-900">{{ audit.tutor.user.get_full_name()|default(audit.tutor.user.username) }}</p>
                                <span class="px-2 py-0.5 rounded-full text-xs font-semibold {% if audit.quality_score >= 80 %}bg-green-100 text-green-800{% elif audit.quality_score >= 50 %}bg-yellow-100 text-yellow-800{% else %}bg-red-100 text-red-800{% endif %}">
                                    {{ audit.quality_score|floatformat(1) }}/100
                                </span>
                            </div>
                            <div class="flex flex-wrap gap-3 text-xs sm:text-sm text-gray-600 mb-2">
                                <span><strong>Type:</strong> {{ audit.get_audit_type_display() }}</span>
                                <span><strong>Date:</strong> {{ audit.created_at|date('M d, Y h:i A') }}</span>
                                {% if audit.audited_by %}
                                <span><strong>By:</strong> {{ audit.audited_by.get_full_name()|default(audit.audited_by.username) }}</span>
                                {% endif %}
                            </div>
                            {% if audit.issues_found %}
                            <div class="mt-2 p-2 bg-red-50 rounded text-xs sm:text-sm">
                                <p class="font-semibold text-red-800 mb-1">Issues Found:</p>
                                <p class="text-red-700">{{ audit.issues_found|truncatewords(25) }}</p>
                            </div>
                            {% endif %}
                            {% if audit.recommendations %}
                            <div class="mt-2 p-2 bg-blue-50 rounded text-xs sm:text-sm">
                                <p class="font-semibold text-blue-800 mb-1">Recommendations:</p>
                                <p class="text-blue-700">{{ audit.recommendations|truncatewords(25) }}</p>
                            </div>
                            {% endif %}
                        </div>
                        <div class="flex flex-col items-end gap-2">
                            {% if audit.is_resolved %}
                            <span class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800 whitespace-nowrap">✅ Resolved</span>
                            {% else %}
                            <span class="px-3 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800 whitespace-nowrap">⏳ Pending</span>
                            {% endif %}
                            <a href="{{ url('admin_panel:conduct_audit', audit.tutor.id) }}" class="text-xs sm:text-sm text-indigo-600 hover:text-indigo-800 font-medium">
                                View/Edit →
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="p-8 sm:p-12 text-center text-gray-500">
                <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <p class="text-sm sm:text-base">No quality audits conducted yet.</p>
                <p class="text-xs sm:text-sm text-gray-400 mt-1">Start by auditing tutors with low quality scores.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

