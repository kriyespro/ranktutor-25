{% extends "base.jinja" %}

{% block title %}Conversation with {{ other_user.get_full_name()|default(other_user.username) }} - RankTutor{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="bg-white rounded-lg shadow mb-6">
        <div class="p-4 border-b">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="h-10 w-10 rounded-full bg-indigo-100 flex items-center justify-center">
                        <span class="text-indigo-600 font-semibold">{{ other_user.get_full_name()|default(other_user.username)|first|upper }}</span>
                    </div>
                    <div class="ml-4">
                        <h2 class="text-xl font-semibold">{{ other_user.get_full_name()|default(other_user.username) }}</h2>
                        {% if contact_revealed %}
                        <p class="text-sm text-gray-500">{{ other_user.email }}</p>
                        {% if other_user.phone %}
                        <p class="text-sm text-gray-500">{{ other_user.phone }}</p>
                        {% endif %}
                        {% else %}
                        <p class="text-sm text-yellow-600">Contact details will be revealed after booking confirmation</p>
                        {% endif %}
                    </div>
                </div>
                <a href="{{ url('messaging:conversations') }}" class="text-gray-500 hover:text-gray-700">
                    ‚Üê Back to Messages
                </a>
            </div>
        </div>
        
        <div class="p-4 h-96 overflow-y-auto" id="messagesContainer">
            {% for message in conversation_messages %}
            {% set is_sender = message.sender.id == user.id %}
            <div class="mb-4 {% if is_sender %}flex justify-end{% endif %}">
                <div class="max-w-xs lg:max-w-md {% if is_sender %}bg-indigo-600 text-white{% else %}bg-gray-200 text-gray-900{% endif %} rounded-lg px-4 py-2">
                    <p class="text-sm">{{ message.content|linebreaks }}</p>
                    <p class="text-xs mt-1 {% if is_sender %}text-indigo-200{% else %}text-gray-500{% endif %}">
                        {{ message.created_at|date('g:i A') }}
                    </p>
                </div>
            </div>
            {% else %}
            <div class="text-center text-gray-500 py-8">
                <p>No messages yet. Start the conversation!</p>
            </div>
            {% endfor %}
        </div>
        
        <form method="post" class="p-4 border-t" id="messageForm">
            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
            <div class="flex gap-2">
                <textarea name="content" placeholder="Type your message..." rows="2" class="flex-1 rounded-md border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 resize-none" required></textarea>
                <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-md hover:bg-indigo-700 self-end">
                    Send
                </button>
            </div>
        </form>
    </div>
</div>

{% block extra_js %}
<script>
    // Auto-scroll to bottom on load
    const container = document.getElementById('messagesContainer');
    if (container) {
        container.scrollTop = container.scrollHeight;
    }
    
    // Auto-scroll after form submission
    const messageForm = document.getElementById('messageForm');
    if (messageForm) {
        messageForm.addEventListener('submit', function() {
            setTimeout(function() {
                if (container) {
                    container.scrollTop = container.scrollHeight;
                }
            }, 100);
        });
    }
    
    // Optional: Auto-refresh messages (every 10 seconds) - less aggressive
    // Uncomment if you want auto-refresh
    // setInterval(function() {
    //     location.reload();
    // }, 10000);
</script>
{% endblock %}
{% endblock %}

