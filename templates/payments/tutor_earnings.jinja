{% extends "base.jinja" %}

{% block title %}Tutor Earnings - RankTutor{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8">
    <div class="mb-6">
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-4">Earnings Dashboard</h1>
        {% include "components/tutor_menu.jinja" %}
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-2">Total Earnings</h3>
            <p class="text-3xl font-bold text-green-600">‚Çπ{{ total_earnings|floatformat(2) }}</p>
            <p class="text-sm text-gray-500 mt-2">All completed payments</p>
        </div>
        <div class="bg-white rounded-lg shadow p-6 border-2 border-orange-300">
            <h3 class="text-lg font-semibold text-gray-700 mb-2">üí∞ On Hold</h3>
            <p class="text-3xl font-bold text-orange-600">‚Çπ{{ on_hold_total|floatformat(2) }}</p>
            <p class="text-sm text-gray-500 mt-2">1 week cooling period</p>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-2">Pending Earnings</h3>
            <p class="text-3xl font-bold text-yellow-600">‚Çπ{{ pending_earnings|floatformat(2) }}</p>
            <p class="text-sm text-gray-500 mt-2">Processing payments</p>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-2">Total Payments</h3>
            <p class="text-3xl font-bold text-indigo-600">{{ recent_payments|length }}</p>
            <p class="text-sm text-gray-500 mt-2">All time</p>
        </div>
    </div>
    
    <!-- Payments On Hold Section -->
    {% if payments_on_hold %}
    <div class="bg-orange-50 border-l-4 border-orange-400 rounded-lg shadow p-6 mb-6">
        <h2 class="text-xl font-semibold text-orange-900 mb-4 flex items-center gap-2">
            <span>‚è≥</span>
            <span>Payments On Hold ({{ payments_on_hold|length }})</span>
        </h2>
        <div class="space-y-3">
            {% for payment in payments_on_hold %}
            <div class="bg-white rounded-lg p-4 border border-orange-200">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3">
                    <div class="flex-1">
                        <h3 class="text-base font-semibold text-gray-900 mb-2">
                            {{ payment.booking.subject.name }} - {{ payment.student.get_full_name()|default(payment.student.username) }}
                        </h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm text-gray-600">
                            <p><strong>Amount:</strong> ‚Çπ{{ payment.tutor_payout|floatformat(2) }}</p>
                            <p><strong>Class Date:</strong> {{ payment.booking.lesson_date|date('M d, Y') }}</p>
                            <p><strong>Hold Until:</strong> {{ payment.hold_until|date('M d, Y h:i A') }}</p>
                            <p><strong>Status:</strong> 
                                {% if payment.can_be_released() %}
                                <span class="text-green-600 font-semibold">Ready to Release</span>
                                {% else %}
                                <span class="text-orange-600">On Hold</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    <div class="sm:ml-4 sm:flex-shrink-0">
                        {% if payment.can_be_released() %}
                        <a href="{{ url('payments:release_payment', payment.id) }}" class="inline-flex items-center justify-center bg-green-600 text-white px-5 py-2.5 rounded-lg hover:bg-green-700 text-sm font-semibold transition-colors shadow-md">
                            ‚úÖ Release Payment
                        </a>
                        {% else %}
                        <button disabled class="inline-flex items-center justify-center bg-gray-300 text-gray-600 px-5 py-2.5 rounded-lg text-sm font-semibold cursor-not-allowed">
                            ‚è≥ Cooling Period
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h2 class="text-xl font-semibold mb-4">Monthly Earnings (Last 6 Months)</h2>
        {% if monthly_earnings %}
            <div class="space-y-2">
                {% for month_data in monthly_earnings %}
                <div class="flex justify-between items-center border-b pb-2">
                    <span class="text-gray-700">{{ month_data.month|date('F Y') }}</span>
                    <span class="font-semibold text-green-600">‚Çπ{{ month_data.total|floatformat(2) }}</span>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-gray-500">No earnings data available</p>
        {% endif %}
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-xl font-semibold mb-4">Recent Payments</h2>
        {% if recent_payments %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Student</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Payout</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for payment in recent_payments %}
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ payment.created_at|date('M d, Y') }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ payment.student.get_full_name()|default(payment.student.username) }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">‚Çπ{{ payment.amount }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-600">‚Çπ{{ payment.tutor_payout }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                    {% if payment.status == 'completed' %}bg-green-100 text-green-800
                                    {% elif payment.status == 'pending' %}bg-yellow-100 text-yellow-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ payment.get_status_display() }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="text-gray-500">No payments yet</p>
        {% endif %}
    </div>
</div>
{% endblock %}

